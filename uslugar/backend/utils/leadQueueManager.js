/**
 * USLUGAR EXCLUSIVE - Lead Queue Manager
 * 
 * Manages the queue system for lead distribution
 * Prevents broadcasting to 6+ providers like Trebam.hr
 */

const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

/**
 * Pronalazi najbolje matchane providere za posao
 * @param {Object} job - Job objekat
 * @param {Number} limit - Max broj providera (default 5)
 * @returns {Array} - Lista provider profila
 */
async function findTopProviders(job, limit = 5) {
  console.log(`üîç Tra≈æim top ${limit} providera za job: ${job.title}`)
  
  // Dohvati kategoriju
  const category = await prisma.category.findUnique({
    where: { id: job.categoryId }
  })
  
  // Pronaƒëi sve providere s tom kategorijom
  let providers = await prisma.providerProfile.findMany({
    where: {
      categories: {
        some: { id: job.categoryId }
      },
      isAvailable: true,
      user: {
        city: job.city // Ista lokacija
      }
    },
    include: {
      user: true,
      licenses: {
        where: {
          isVerified: true,
          OR: [
            { expiresAt: null },
            { expiresAt: { gt: new Date() } }
          ]
        }
      }
    }
  })
  
  console.log(`   Pronaƒëeno ${providers.length} potencijalnih providera`)
  
  // Ako kategorija zahtijeva licencu, filtriraj samo one s validnom licencom
  if (category.requiresLicense) {
    providers = providers.filter(p => 
      p.licenses.some(l => 
        l.licenseType === category.licenseType
      )
    )
    console.log(`   Nakon filtriranja po licencama: ${providers.length}`)
  }
  
  // Sortiraj po ocjeni i broju recenzija
  providers.sort((a, b) => {
    // Prvo po ocjeni
    if (b.ratingAvg !== a.ratingAvg) {
      return b.ratingAvg - a.ratingAvg
    }
    // Zatim po broju ocjena (vi≈°e ocjena = pouzdaniji)
    return b.ratingCount - a.ratingCount
  })
  
  const topProviders = providers.slice(0, limit)
  console.log(`‚úÖ Top ${topProviders.length} providera odabrano`)
  
  return topProviders
}

/**
 * Kreira queue za job
 * @param {String} jobId - ID posla
 * @param {Array} providers - Lista providera
 * @returns {Array} - Kreirane queue stavke
 */
async function createLeadQueue(jobId, providers) {
  console.log(`üìã Kreiram queue za job ${jobId}`)
  
  const queueItems = []
  
  for (let i = 0; i < providers.length; i++) {
    const queueItem = await prisma.leadQueue.create({
      data: {
        jobId,
        providerId: providers[i].userId,
        position: i + 1,
        status: i === 0 ? 'OFFERED' : 'WAITING',
        offeredAt: i === 0 ? new Date() : null,
        expiresAt: i === 0 ? new Date(Date.now() + 24 * 60 * 60 * 1000) : null // 24h
      }
    })
    
    queueItems.push(queueItem)
    console.log(`   Pozicija ${i + 1}: ${providers[i].user.fullName} (${providers[i].user.email})`)
  }
  
  // Po≈°alji notifikaciju prvom provideru
  if (queueItems.length > 0) {
    await sendLeadOfferNotification(queueItems[0])
  }
  
  return queueItems
}

/**
 * Ponudi lead sljedeƒáem provideru u queueu
 * @param {String} jobId - ID posla
 */
async function offerToNextInQueue(jobId) {
  console.log(`‚û°Ô∏è Tra≈æim sljedeƒáeg providera u queueu za job ${jobId}`)
  
  // Pronaƒëi sljedeƒáeg u queueu koji ƒçeka
  const nextInQueue = await prisma.leadQueue.findFirst({
    where: { 
      jobId,
      status: 'WAITING'
    },
    orderBy: { position: 'asc' }
  })
  
  if (!nextInQueue) {
    console.log('   ‚ö†Ô∏è Nema vi≈°e providera u queueu')
    
    // Provjeri koliko ih je ukupno odbilo
    const declinedCount = await prisma.leadQueue.count({
      where: {
        jobId,
        status: { in: ['DECLINED', 'EXPIRED'] }
      }
    })
    
    if (declinedCount >= 3) {
      console.log('   üö® 3+ providera odbilo - oznaƒçavam job kao problematiƒçan')
      await prisma.job.update({
        where: { id: jobId },
        data: { 
          leadStatus: 'EXPIRED',
          qualityScore: 0
        }
      })
      // Obavijesti klijenta
      await notifyClientAboutProblematicJob(jobId)
    }
    
    return null
  }
  
  // A≈æuriraj status
  await prisma.leadQueue.update({
    where: { id: nextInQueue.id },
    data: {
      status: 'OFFERED',
      offeredAt: new Date(),
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24h
    }
  })
  
  console.log(`   ‚úÖ Lead ponuƒëen provideru na poziciji ${nextInQueue.position}`)
  
  // Po≈°alji notifikaciju
  await sendLeadOfferNotification(nextInQueue)
  
  return nextInQueue
}

/**
 * Provider odgovara na ponudu
 * @param {String} queueId - ID queue stavke
 * @param {String} response - 'INTERESTED' | 'NOT_INTERESTED'
 * @param {String} userId - ID providera koji odgovara
 */
async function respondToLeadOffer(queueId, response, userId) {
  const queueItem = await prisma.leadQueue.findUnique({
    where: { id: queueId },
    include: { job: true }
  })
  
  if (!queueItem) {
    throw new Error('Queue item ne postoji')
  }
  
  if (queueItem.providerId !== userId) {
    throw new Error('Unauthorized - ovo nije va≈° lead')
  }
  
  if (queueItem.status !== 'OFFERED') {
    throw new Error('Lead vi≈°e nije dostupan')
  }
  
  console.log(`üí¨ Provider ${userId} odgovorio: ${response}`)
  
  if (response === 'INTERESTED') {
    // Provider ≈æeli kupiti lead
    const leadPrice = queueItem.job.leadPrice
    
    // Provjeri ima li dovoljno kredita
    const subscription = await prisma.subscription.findUnique({
      where: { userId }
    })
    
    if (!subscription || subscription.creditsBalance < leadPrice) {
      throw new Error('Nemate dovoljno kredita')
    }
    
    // Poƒçni transakciju
    return await prisma.$transaction(async (tx) => {
      // Oduzmi kredite
      await tx.subscription.update({
        where: { userId },
        data: {
          creditsBalance: { decrement: leadPrice },
          lifetimeCreditsUsed: { increment: leadPrice }
        }
      })
      
      // Kreiraj credit transaction
      await tx.creditTransaction.create({
        data: {
          userId,
          type: 'LEAD_PURCHASE',
          amount: -leadPrice,
          balance: subscription.creditsBalance - leadPrice,
          description: `Kupovina ekskluzivnog leada: ${queueItem.job.title}`,
          relatedJobId: queueItem.jobId
        }
      })
      
      // Kreiraj lead purchase
      const leadPurchase = await tx.leadPurchase.create({
        data: {
          jobId: queueItem.jobId,
          providerId: userId,
          creditsSpent: leadPrice,
          leadPrice: leadPrice,
          status: 'ACTIVE'
        }
      })
      
      // A≈æuriraj job
      await tx.job.update({
        where: { id: queueItem.jobId },
        data: {
          leadStatus: 'ASSIGNED',
          assignedProviderId: userId
        }
      })
      
      // A≈æuriraj queue status
      await tx.leadQueue.update({
        where: { id: queueId },
        data: {
          status: 'ACCEPTED',
          respondedAt: new Date(),
          response: 'INTERESTED'
        }
      })
      
      // Poni≈°ti sve ostale u queueu
      await tx.leadQueue.updateMany({
        where: {
          jobId: queueItem.jobId,
          id: { not: queueId }
        },
        data: { status: 'SKIPPED' }
      })
      
      console.log(`‚úÖ Lead uspje≈°no kupljen za ${leadPrice} kredita`)
      
      return leadPurchase
    })
  } else {
    // Provider odbija lead
    await prisma.leadQueue.update({
      where: { id: queueId },
      data: {
        status: 'DECLINED',
        respondedAt: new Date(),
        response: 'NOT_INTERESTED'
      }
    })
    
    console.log(`‚ùå Provider odbio lead`)
    
    // Ponudi sljedeƒáem u queueu
    await offerToNextInQueue(queueItem.jobId)
  }
}

/**
 * Cron job - provjerava istekle ponude
 * Pokreƒáe se svaki sat
 */
async function checkExpiredOffers() {
  console.log('‚è∞ Provjeravam istekle ponude...')
  
  const expiredOffers = await prisma.leadQueue.findMany({
    where: {
      status: 'OFFERED',
      expiresAt: { lt: new Date() }
    }
  })
  
  console.log(`   Pronaƒëeno ${expiredOffers.length} isteklih ponuda`)
  
  for (const offer of expiredOffers) {
    console.log(`   Istekao offer za job ${offer.jobId}, pozicija ${offer.position}`)
    
    // Oznaƒçi kao expired
    await prisma.leadQueue.update({
      where: { id: offer.id },
      data: {
        status: 'EXPIRED',
        response: 'NO_RESPONSE'
      }
    })
    
    // Ponudi sljedeƒáem
    await offerToNextInQueue(offer.jobId)
  }
  
  console.log('‚úÖ Provjera isteklih ponuda zavr≈°ena')
}

/**
 * ≈†alje notifikaciju provideru o ponuƒëenom leadu
 */
async function sendLeadOfferNotification(queueItem) {
  const job = await prisma.job.findUnique({
    where: { id: queueItem.jobId },
    include: { 
      user: true,
      category: true
    }
  })
  
  const provider = await prisma.user.findUnique({
    where: { id: queueItem.providerId }
  })
  
  // Kreiraj notifikaciju u bazi
  await prisma.notification.create({
    data: {
      userId: provider.id,
      type: 'NEW_JOB',
      title: 'üéØ Novi ekskluzivni lead dostupan!',
      message: `${job.category.name}: ${job.title} u ${job.city}. Cijena: ${job.leadPrice} kredita. Imate 24h da odgovorite.`,
      jobId: job.id
    }
  })
  
  // TODO: Po≈°alji email
  // TODO: Po≈°alji push notifikaciju
  // TODO: SMS za urgentne poslove
  
  console.log(`üìß Notifikacija poslana provideru ${provider.email}`)
}

/**
 * Obavje≈°tava klijenta da je job problematiƒçan
 */
async function notifyClientAboutProblematicJob(jobId) {
  const job = await prisma.job.findUnique({
    where: { id: jobId },
    include: { 
      user: true,
      category: true
    }
  })
  
  await prisma.notification.create({
    data: {
      userId: job.userId,
      type: 'SYSTEM',
      title: '‚ö†Ô∏è Va≈° oglas zahtijeva reviziju',
      message: `Vi≈°e providera nije zainteresirano za va≈° oglas "${job.title}". Mo≈æda trebate revidirati opis, cijenu ili lokaciju.`,
      jobId: job.id
    }
  })
  
  console.log(`üìß Klijent ${job.user.email} obavije≈°ten o problematiƒçnom jobu`)
}

module.exports = {
  findTopProviders,
  createLeadQueue,
  offerToNextInQueue,
  respondToLeadOffer,
  checkExpiredOffers,
  sendLeadOfferNotification,
  notifyClientAboutProblematicJob
}

