FROM node:20-bookworm-slim AS prisma-tasks
WORKDIR /app

# System deps za Prisma CLI
RUN apt-get update -y && apt-get install -y --no-install-recommends     openssl ca-certificates && rm -rf /var/lib/apt/lists/*

# Trebaju nam devDependencies jer Prisma CLI obiƒçno stoji u devDeps
COPY package*.json ./
RUN npm ci --ignore-scripts

# Multi-file schema layout
COPY prisma ./prisma

# Opcionalno: Kopiraj lokalno generirani Prisma Client ako postoji
# Dockerfile automatski detektira i koristi lokalno generirani Prisma Client
# Workaround za Prisma CDN probleme: generiraj lokalno s "npx prisma generate" prije build-a
RUN mkdir -p node_modules/.prisma node_modules/@prisma 2>/dev/null || true

ENV PRISMA_GENERATE_SKIP_AUTOINSTALL=1
ENV PRISMA_OPENSSL_VERSION=3.0.x
ENV PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1

# Provjeri postoji li veƒá lokalno generirani Prisma Client
# Ako postoji, preskoƒçi generiranje (koristi se za workaround kada Prisma CDN nije dostupan)
RUN if [ -d "node_modules/.prisma" ] && [ -d "node_modules/@prisma/client" ]; then \
        echo "‚úÖ Using pre-generated Prisma Client from local cache" && \
        echo "   Skipping prisma generate (CDN workaround)"; \
    else \
        echo "üì¶ Prisma Client not found in cache, generating from CDN..." && \
        MAX_ATTEMPTS=5; \
        SUCCESS=0; \
        for i in $(seq 1 $MAX_ATTEMPTS); do \
            echo "Attempt $i/$MAX_ATTEMPTS: Generating Prisma Client..." && \
            if npx prisma generate --schema=./prisma/schema.prisma 2>&1; then \
                if [ -d "node_modules/.prisma" ] && [ -d "node_modules/@prisma/client" ]; then \
                    echo "‚úÖ Prisma Client generated successfully!" && \
                    SUCCESS=1 && \
                    break; \
                fi; \
            fi; \
            echo "‚ö†Ô∏è Attempt $i/$MAX_ATTEMPTS failed. Waiting before retry..." && \
            sleep $((i * 5)); \
        done; \
        if [ $SUCCESS -eq 0 ]; then \
            echo "‚ùå ERROR: All $MAX_ATTEMPTS attempts failed. Prisma CDN appears to be down." && \
            echo "" && \
            echo "üìã WORKAROUND: Generate Prisma Client locally before building:" && \
            echo "   1. cd uslugar/backend" && \
            echo "   2. npx prisma generate" && \
            echo "   3. docker build -f Dockerfile.prisma ." && \
            echo "" && \
            echo "   The Dockerfile will automatically use the pre-generated client." && \
            echo "" && \
            echo "   Or check Prisma status: https://www.prisma.io/status" && \
            exit 1; \
        fi; \
    fi

# Default: pomoƒá; u CI/one-off zadatku override-at ƒáe se "command"
CMD ["sh","-lc","npx prisma --help"]
