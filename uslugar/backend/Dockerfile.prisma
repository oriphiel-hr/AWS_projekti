FROM node:20-bookworm-slim AS prisma-tasks
WORKDIR /app

# System deps za Prisma CLI
RUN apt-get update -y && apt-get install -y --no-install-recommends     openssl ca-certificates && rm -rf /var/lib/apt/lists/*

# Trebaju nam devDependencies jer Prisma CLI obično stoji u devDeps
COPY package*.json ./
RUN npm ci --ignore-scripts

# Multi-file schema layout
COPY prisma ./prisma

ENV PRISMA_GENERATE_SKIP_AUTOINSTALL=1
ENV PRISMA_OPENSSL_VERSION=3.0.x
ENV PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1

# Generiraj Prisma Client s retry logikom i fallback opcijama
# Retry do 5 puta s povećanjem vremena između pokušaja (5s, 10s, 15s, 20s, 25s)
# Ako sve ne uspije, pokušaj koristiti lokalni cache ili pričekaj duže
RUN set -e; \
    MAX_ATTEMPTS=5; \
    for i in $(seq 1 $MAX_ATTEMPTS); do \
        echo "Attempt $i/$MAX_ATTEMPTS: Generating Prisma Client..." && \
        (npx prisma generate --schema=./prisma/schema.prisma 2>&1 || true) && \
        if [ -d "node_modules/.prisma" ] && [ -d "node_modules/@prisma/client" ]; then \
            echo "Prisma Client generated successfully!" && exit 0; \
        else \
            echo "Attempt $i/$MAX_ATTEMPTS failed. Waiting before retry..." && \
            sleep $((i * 5)); \
        fi; \
    done; \
    echo "WARNING: All $MAX_ATTEMPTS attempts failed. Prisma CDN appears to be down." && \
    echo "This is likely a temporary issue. Please try again later or generate Prisma Client locally." && \
    exit 1

# Default: pomoć; u CI/one-off zadatku override-at će se "command"
CMD ["sh","-lc","npx prisma --help"]
