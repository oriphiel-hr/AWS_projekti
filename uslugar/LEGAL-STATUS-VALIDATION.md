# ‚öñÔ∏è Pravni Status - Validacija za Pru≈æatelje Usluga

## üìã Zahtjev

**Pru≈æatelj usluga NE MO≈ΩE biti privatna osoba po zakonu!**

Svaki pru≈æatelj mora imati:
- ‚úÖ Pravni oblik (obrt, d.o.o., j.d.o.o., itd.)
- ‚úÖ OIB (porezni identifikacijski broj)
- ‚úÖ Naziv firme/obrta

---

## ‚úÖ ≈†to je Implementirano

### 1. **Seed Data - Hrvatski Pravni Oblici**

**Fajl:** `backend/prisma/seed.js`

Dodano 8 pravnih oblika:
- `OBRT` - Obrt
- `DOO` - d.o.o. (Dru≈°tvo s ograniƒçenom odgovorno≈°ƒáu)
- `JDOO` - j.d.o.o. (Jednostavno dru≈°tvo s ograniƒçenom odgovorno≈°ƒáu)
- `DD` - d.d. (Dioniƒçko dru≈°tvo)
- `ZDR` - Zadruga
- `VD` - v.d. (Javno trgovaƒçko dru≈°tvo)
- `KD` - k.d. (Komanditno dru≈°tvo)
- `PAUSALAC` - Pau≈°alno oporezivanje

### 2. **Validacija pri Registraciji**

**Fajl:** `backend/src/routes/auth.js` - `POST /api/auth/register`

```javascript
if (role === 'PROVIDER') {
  if (!legalStatusId || !taxId || !companyName) {
    return res.status(400).json({ 
      error: 'Pru≈æatelj usluga mora imati pravni oblik',
      message: 'Za registraciju kao pru≈æatelj usluga obavezno je navesti: pravni status (obrt, d.o.o., itd.), OIB i naziv firme/obrta.',
      requiredFields: ['legalStatusId', 'taxId', 'companyName']
    });
  }
}
```

**Obavezna polja za PROVIDER-e:**
- `legalStatusId` - ID iz LegalStatus tabele
- `taxId` - OIB broj (11 brojeva)
- `companyName` - Naziv obrta/firme

### 3. **Validacija pri Upgrade-u USER ‚Üí PROVIDER**

**Fajl:** `backend/src/routes/auth.js` - `POST /api/auth/upgrade-to-provider`

```javascript
POST /api/auth/upgrade-to-provider

Body:
{
  "email": "user@example.com",
  "password": "password123",
  "legalStatusId": "legal-status-id",  // OBAVEZNO
  "taxId": "12345678901",              // OBAVEZNO
  "companyName": "Moj Obrt d.o.o."     // OBAVEZNO
}
```

### 4. **Novi API Endpoint - Legal Statuses**

**Fajl:** `backend/src/routes/legal-statuses.js`

```javascript
GET /api/legal-statuses
```

**Response:**
```json
[
  {
    "id": "...",
    "code": "OBRT",
    "name": "Obrt",
    "description": "Obrtni≈°tvo - samostalna djelatnost fiziƒçke osobe",
    "isActive": true,
    "createdAt": "..."
  },
  {
    "id": "...",
    "code": "DOO",
    "name": "d.o.o.",
    "description": "Dru≈°tvo s ograniƒçenom odgovorno≈°ƒáu",
    "isActive": true,
    "createdAt": "..."
  },
  ...
]
```

---

## üöÄ Deployment - Seed Legal Statuses

### Lokalno (Development)

```bash
cd uslugar/backend

# Pokreni seed
npx prisma db seed
```

### Produkcija (AWS RDS)

**Opcija 1: Via Seed Script**

```bash
# Setuj DATABASE_URL za production
export DATABASE_URL="postgresql://user:pass@host:5432/db?schema=public"

# Pokreni seed
npx prisma db seed
```

**Opcija 2: SQL Direct Insert**

Ako seed ne radi, mo≈æete direktno insertovati u bazu:

```sql
INSERT INTO "LegalStatus" (id, code, name, description, "isActive", "createdAt")
VALUES
  (gen_random_uuid(), 'OBRT', 'Obrt', 'Obrtni≈°tvo - samostalna djelatnost fiziƒçke osobe', true, NOW()),
  (gen_random_uuid(), 'DOO', 'd.o.o.', 'Dru≈°tvo s ograniƒçenom odgovorno≈°ƒáu', true, NOW()),
  (gen_random_uuid(), 'JDOO', 'j.d.o.o.', 'Jednostavno dru≈°tvo s ograniƒçenom odgovorno≈°ƒáu', true, NOW()),
  (gen_random_uuid(), 'DD', 'd.d.', 'Dioniƒçko dru≈°tvo', true, NOW()),
  (gen_random_uuid(), 'ZDR', 'Zadruga', 'Zadruga - gospodarski subjekt', true, NOW()),
  (gen_random_uuid(), 'VD', 'v.d.', 'Javno trgovaƒçko dru≈°tvo (vl. dru≈°tvo)', true, NOW()),
  (gen_random_uuid(), 'KD', 'k.d.', 'Komanditno dru≈°tvo', true, NOW()),
  (gen_random_uuid(), 'PAUSALAC', 'Pau≈°alno oporezivanje', 'Samostalna djelatnost - pau≈°alno oporezivanje', true, NOW())
ON CONFLICT (code) DO NOTHING;
```

---

## üß™ Testiranje

### Test 1: Registracija PROVIDER-a bez pravnog statusa (FAIL)

```bash
curl -X POST https://uslugar.api.oriph.io/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "fullName": "Test Provider",
    "role": "PROVIDER"
  }'
```

**Expected Response:** `400 Bad Request`
```json
{
  "error": "Pru≈æatelj usluga mora imati pravni oblik",
  "message": "Za registraciju kao pru≈æatelj usluga obavezno je navesti: pravni status (obrt, d.o.o., itd.), OIB i naziv firme/obrta.",
  "requiredFields": ["legalStatusId", "taxId", "companyName"]
}
```

### Test 2: Registracija PROVIDER-a SA pravnim statusom (SUCCESS)

```bash
# Prvo dohvati legal statuses
curl https://uslugar.api.oriph.io/api/legal-statuses

# Uzmi ID za "Obrt"
LEGAL_STATUS_ID="..."

# Registriraj se sa pravnim statusom
curl -X POST https://uslugar.api.oriph.io/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "obrt@example.com",
    "password": "password123",
    "fullName": "Ivan Horvat",
    "role": "PROVIDER",
    "legalStatusId": "'$LEGAL_STATUS_ID'",
    "taxId": "12345678901",
    "companyName": "Obrt Horvat"
  }'
```

**Expected Response:** `200 OK`
```json
{
  "token": "...",
  "user": {
    "id": "...",
    "email": "obrt@example.com",
    "role": "PROVIDER",
    "fullName": "Ivan Horvat",
    "isVerified": false
  },
  "message": "Registracija uspje≈°na! Provjerite email za aktivacijski link."
}
```

### Test 3: Upgrade USER ‚Üí PROVIDER sa pravnim statusom

```bash
# Login kao USER
curl -X POST https://uslugar.api.oriph.io/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'

# Upgrade na PROVIDER
curl -X POST https://uslugar.api.oriph.io/api/auth/upgrade-to-provider \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "legalStatusId": "'$LEGAL_STATUS_ID'",
    "taxId": "98765432101",
    "companyName": "Obrt Mariƒá"
  }'
```

**Expected Response:** `200 OK`
```json
{
  "message": "Successfully upgraded to provider!",
  "token": "...",  // Novi token sa role=PROVIDER
  "user": {
    "id": "...",
    "email": "user@example.com",
    "role": "PROVIDER",  // Promijenjena rola
    "fullName": "...",
    "isVerified": true
  }
}
```

---

## üìä Database Schema

### LegalStatus Model

```prisma
model LegalStatus {
  id          String   @id @default(cuid())
  code        String   @unique // INDIVIDUAL, SOLE_TRADER, COMPANY, etc.
  name        String   // Naziv na hrvatskom
  description String?  // Detaljan opis
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  users       User[]   @relation("UserLegalStatus")
  providers   ProviderProfile[]
}
```

### User Model (Povezano)

```prisma
model User {
  // ...
  legalStatus      LegalStatus?  @relation("UserLegalStatus", fields: [legalStatusId], references: [id])
  legalStatusId    String?       // Pravni status
  taxId            String?       // OIB
  companyName      String?       // Naziv firme
  // ...
}
```

### ProviderProfile Model (Povezano)

```prisma
model ProviderProfile {
  // ...
  legalStatus    LegalStatus?  @relation(fields: [legalStatusId], references: [id])
  legalStatusId  String?       // Pravni status (obrt, d.o.o., itd.)
  taxId          String?       // OIB (porezni broj)
  companyName    String?       // Naziv obrta/firme
  // ...
}
```

---

## üéØ Frontend Integration

### 1. Dohvaƒáanje Pravnih Statusa

```javascript
// Fetch legal statuses za dropdown
const response = await fetch('https://uslugar.api.oriph.io/api/legal-statuses');
const legalStatuses = await response.json();

// Prika≈æi kao dropdown
<select name="legalStatusId">
  {legalStatuses.map(status => (
    <option key={status.id} value={status.id}>
      {status.name} - {status.description}
    </option>
  ))}
</select>
```

### 2. Registracijska Forma za PROVIDER-a

```javascript
<form onSubmit={handleRegister}>
  <input name="email" required />
  <input name="password" required />
  <input name="fullName" required />
  
  {/* OBAVEZNO za PROVIDER-e */}
  <select name="legalStatusId" required>
    <option value="">Odaberite pravni oblik...</option>
    {legalStatuses.map(status => (
      <option key={status.id} value={status.id}>
        {status.name}
      </option>
    ))}
  </select>
  
  <input name="taxId" placeholder="OIB (11 brojeva)" required />
  <input name="companyName" placeholder="Naziv firme/obrta" required />
  
  <button type="submit">Registriraj se kao pru≈æatelj</button>
</form>
```

### 3. Upgrade na PROVIDER Forma

```javascript
<form onSubmit={handleUpgrade}>
  <h3>Postani Pru≈æatelj Usluga</h3>
  <p>Za pru≈æanje usluga potreban je pravni oblik (obrt, d.o.o., itd.)</p>
  
  <input name="password" type="password" placeholder="Potvrdi lozinku" required />
  
  <select name="legalStatusId" required>
    <option value="">Odaberite pravni oblik...</option>
    {legalStatuses.map(status => (
      <option key={status.id} value={status.id}>
        {status.name} - {status.description}
      </option>
    ))}
  </select>
  
  <input name="taxId" placeholder="OIB" required />
  <input name="companyName" placeholder="Naziv firme/obrta" required />
  
  <button type="submit">Postani pru≈æatelj</button>
</form>
```

---

## ‚úÖ Benefits

### Pravna Usklaƒëenost:
- ‚úÖ Pru≈æatelji moraju imati pravni oblik (zakon)
- ‚úÖ Evidentiran OIB za porezne svrhe
- ‚úÖ Evidentirani podaci o firmi/obrtu

### Transparentnost:
- ‚úÖ Korisnici vide pravni oblik pru≈æatelja
- ‚úÖ Veƒáa sigurnost i povjerenje
- ‚úÖ Lak≈°e rje≈°avanje sporova

### Kontrola:
- ‚úÖ Admin mo≈æe vidjeti pravni status svih pru≈æatelja
- ‚úÖ Filtriranje po pravnom obliku
- ‚úÖ Izvje≈°taji za porezne organe

---

## üìã Deployment Checklist

### Backend:
- [x] ‚úÖ Seed data dodani (legal statuses)
- [x] ‚úÖ Validacija u auth.js (register + upgrade)
- [x] ‚úÖ Novi endpoint `/api/legal-statuses`
- [x] ‚úÖ Router registrovan u server.js
- [ ] üîÑ Seed pokrenut na production bazi
- [ ] üîÑ Deploy backend na AWS

### Frontend:
- [ ] üîÑ Fetch legal statuses API
- [ ] üîÑ Dropdown za pravni status u registraciji
- [ ] üîÑ Forma za upgrade sa pravnim statusom
- [ ] üîÑ Prikazati pravni status u provider profilu

### Database:
- [x] ‚úÖ Schema OK (LegalStatus model veƒá postoji)
- [ ] üîÑ Seed data insert-ovani

---

## üöÄ Next Steps

1. **Seed Legal Statuses na Production:**
   ```bash
   # Connect to production DB and run seed
   DATABASE_URL="..." npx prisma db seed
   ```

2. **Deploy Backend na AWS:**
   ```bash
   cd uslugar/backend
   .\deploy-legal-status-validation.ps1
   ```

3. **Frontend UI:**
   - Dodati legal statuses dropdown
   - Update registracijsku formu
   - Update upgrade-to-provider formu

---

**Datum implementacije:** 20. oktobar 2025  
**Status:** ‚úÖ Backend Ready for Deployment  
**Pravni zahtjev:** ‚úÖ Ispunjen (PROVIDER mora biti pravno lice)

